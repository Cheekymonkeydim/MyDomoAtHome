#!/bin/bash
# This file was autogenerated by node-deb 0.1.6
set -e

init_type='auto'

die() {
  echo "$@" >&2
  exit 1
}

addUser() {
  declare -r user="$1"
  declare -r uid="$2"

  if [ -z "$uid" ]; then
    declare -r uid_flags=""
  else
    declare -r uid_flags="--uid $uid"
  fi

  declare -r group=${3:-$user}
  declare -r descr=${4:-No description}
  declare -r shell=${5:-/bin/false}

  if ! getent passwd | grep -q "^$user:"; then
    echo "Creating system user: $user in $group with $descr and shell $shell"
    useradd $uid_flags --gid $group --no-create-home --system --shell $shell -c "$descr" $user
  fi
}

addGroup() {
  declare -r group="$1"
  declare -r gid="$2"

  if [ -z "$gid" ]; then
    declare -r gid_flags=""
  else
    declare -r gid_flags="--gid $gid"
  fi

  if ! getent group | grep -q "^$group:" ; then
    echo "Creating system group: $group"
    groupadd $gid_flags --system $group
  fi
}

npm_install() {
  cd "/usr/share/$1/app"
  if [ -e 'node_modules' ]; then
    rm -rf 'node_modules'
  fi
  sudo -u www-data npm install --production
}

start_service () {
  declare -r service_name="$1"

  if hash service 2> /dev/null; then
    if [[ "$init_type" == 'auto' || "$init_type" == 'upstart' ]]; then
      service "$service_name" start || echo "${service_name} could not be registered or started"
      service enable "$service_name"
    fi
  elif hash start 2> /dev/null; then
    if [[ "$init_type" == 'auto' || "$init_type" == 'upstart' ]]; then
      start "$service_name" || echo "${service_name} could not be registered or started"
      echo ENABLED=1 > "/etc/default/$service_name"
      echo start > "/etc/init/$service_name.override"
    fi
  elif hash systemctl 2> /dev/null; then
    if [[ "$init_type" == 'auto' || "$init_type" == 'systemd' ]]; then
      {
        systemctl enable "$service_name.service" && \
	systemctl preset "$service_name.service" && \
        systemctl start "$service_name.service"
      } || echo "${service_name} could not be registered or started"
    fi
  else
    die 'Your system does not appear to use upstart or systemd, so the service could not be started'
  fi
}

addGroup 'www-data' ''
addUser 'www-data' '' 'www-data' 'www-data user-daemon' '/bin/false'

if ! [ -d '/var/log/mydomoathome' ]; then
  mkdir -p '/var/log/mydomoathome'
fi

if ! [ -d '/var/www' ]; then
  mkdir -p '/var/www'
fi

if [ ! -f '/etc/mydomoathome/config.json' ]; then
  mv '/etc/mydomoathome/config.json.dist' '/etc/mydomoathome/config.json'
fi

chown 'www-data:www-data' '/var/log/mydomoathome'
chown 'www-data:www-data' '/var/www/'
chown -R 'www-data:www-data' '/usr/share/mydomoathome'
chown 'www-data:www-data' /etc/mydomoathome/config.json

#NPM specifics
cd /usr/share/mydomoathome/app
npm config set loglevel warn
npm_install 'mydomoathome'
#sudo -u www-data /usr/bin/npm install --production

update-rc.d mydomoathome defaults

if [[ "$init_type" == 'auto' ]]; then
  start_service 'mydomoathome'
fi
